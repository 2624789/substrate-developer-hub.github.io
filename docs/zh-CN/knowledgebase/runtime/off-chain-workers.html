<!DOCTYPE html><html lang="zh-CN"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>链下工作机 · Substrate Developer Hub</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="本文将从技术实现层面来介绍如何在 Substrate runtime 中使用链下工作机。 有关链下工作机的概念总览，可参阅[《概念指南》](../learn-substrate/off-chain-features#off-chain-workers)。"/><meta name="docsearch:language" content="zh-CN"/><meta property="og:title" content="链下工作机 · Substrate Developer Hub"/><meta property="og:type" content="website"/><meta property="og:url" content="https://substrate-developer-hub.github.io//"/><meta property="og:description" content="本文将从技术实现层面来介绍如何在 Substrate runtime 中使用链下工作机。 有关链下工作机的概念总览，可参阅[《概念指南》](../learn-substrate/off-chain-features#off-chain-workers)。"/><meta property="og:image" content="https://substrate-developer-hub.github.io/img/substrate-dev-hub-card.png"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="https://substrate-developer-hub.github.io/img/substrate-dev-hub-card.png"/><link rel="shortcut icon" href="/img/favicon.png"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script type="text/javascript" src="/js/clipboard.min.js"></script><script type="text/javascript" src="/js/code-block-buttons.js"></script><script type="text/javascript" src="/js/load.js"></script><script type="text/javascript" src="/js/redirect-next.js"></script><script type="text/javascript" src="/js/config.js" defer=""></script><script type="text/javascript" src="/js/klaro.min.js" defer=""></script><script src="https://unpkg.com/vanilla-back-to-top@7.1.14/dist/vanilla-back-to-top.min.js"></script><script>
        document.addEventListener('DOMContentLoaded', function() {
          addBackToTop(
            {"zIndex":100}
          )
        });
        </script><script src="/js/scrollSpy.js"></script><link rel="stylesheet" href="/css/prism.css"/><link rel="stylesheet" href="/css/main.css"/><script src="/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/zh-CN"><img class="logo" src="/img/Substrate-logo.svg" alt="Substrate Developer Hub"/><h2 class="headerTitleWithLogo">Substrate Developer Hub</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class=""><a href="/zh-CN/tutorials" target="_self">教程</a></li><li class="siteNavGroupActive"><a href="/docs/zh-CN/" target="_self">知识库</a></li><li class=""><a href="https://substrate.dev/recipes/" target="_self">进阶菜谱</a></li><li class=""><a href="https://substrate.dev/rustdocs/" target="_self">API 文档</a></li><li class="navSearchWrapper reactNavSearchWrapper"><input type="text" id="search_input_react" placeholder="Search" title="Search"/></li><span><li><a id="languages-menu" href="#"><img class="languages-icon" src="/img/language.svg" alt="Languages icon"/>简体中文</a><div id="languages-dropdown" class="hide"><ul id="languages-dropdown-items"><li><a href="/docs/en/knowledgebase/runtime/off-chain-workers">English</a></li><li><a href="https://crowdin.com/project/substrate-developer-hub" target="_blank" rel="noreferrer noopener">协助翻译</a></li></ul></div></li><script>
        const languagesMenuItem = document.getElementById("languages-menu");
        const languagesDropDown = document.getElementById("languages-dropdown");
        languagesMenuItem.addEventListener("click", function(event) {
          event.preventDefault();

          if (languagesDropDown.className == "hide") {
            languagesDropDown.className = "visible";
          } else {
            languagesDropDown.className = "hide";
          }
        });
      </script></span></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><div class="hamburger-menu"><div class="line1"></div><div class="line2"></div><div class="line3"></div></div></div><h2><i>›</i><span>Runtime</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">开始<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/docs/zh-CN/">总览</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/getting-started/">安装</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/getting-started/windows-users">在 Windows 系统开始</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/getting-started/glossary">词汇表</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">学习 Substrate<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/learn-substrate/extrinsics">Extrinsics</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/learn-substrate/tx-pool">交易池</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/learn-substrate/account-abstractions">账户摘要</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/learn-substrate/session-keys">会话密钥</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/learn-substrate/weight">交易权重</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/learn-substrate/off-chain-features">链下功能</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Runtime<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/runtime/">Runtime 总览</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/runtime/primitives">Runtime 的基本类型</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/runtime/frame">FRAME</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/runtime/pallets">Pallets</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/runtime/macros">Runtime宏</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/runtime/metadata">Runtime 元数据</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/runtime/storage">Runtime 存储</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/runtime/origin">Runtime 来源</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/runtime/execution">Runtime 执行流程</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/runtime/events">Runtime事件</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/runtime/errors">Runtime 错误</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/runtime/fees">交易费用</a></li><li class="navListItem navListItemActive"><a class="navItem" href="/docs/zh-CN/knowledgebase/runtime/off-chain-workers">链下工作机</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/runtime/debugging">调试</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/runtime/tests">Runtime 测试</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/runtime/randomness">链上随机生成</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/runtime/upgrades">Runtime 升级</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">智能合约<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/smart-contracts/overview">总览</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/smart-contracts/">ink! 智能合约</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/smart-contracts/ink-fundamentals">ink! 概念</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/smart-contracts/ink-development">ink! 开发</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/smart-contracts/evm-pallet">EVM 模块</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/smart-contracts/faq">ink! 常问问题</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">整合<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/integrate/polkadot-js">Polkadot-JS</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/integrate/libraries">客户端库</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/integrate/chain-spec">链描述</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/integrate/subkey">Subkey 工具</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/integrate/memory-profiling">内存分析</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">进阶<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/advanced/codec">SCALE 编解码器</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/advanced/consensus">共识机制</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/advanced/block-import">区块导入过程</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/advanced/executor">执行器</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/advanced/cryptography">密码学</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/advanced/storage">存储</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/advanced/ss58-address-format">SS58 地址格式</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">贡献<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/docs/zh-CN/contribute/help-translate">协助翻译</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              var headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                var el = event.target;
                while(el !== headings){
                  if (el.tagName === 'A') {
                    document.body.classList.remove('tocActive');
                    break;
                  } else{
                    el = el.parentNode;
                  }
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer docsContainer"><div class="wrapper"><div class="post"><header class="postHeader"><a class="edit-page-link button" href="https://crowdin.com/project/substrate-developer-hub/zh-CN" target="_blank" rel="noreferrer noopener">Translate</a><h1 id="__docusaurus" class="postHeaderTitle">链下工作机</h1></header><article><div><span><p>本文将从技术实现层面来介绍如何在 Substrate runtime 中使用链下工作机。 有关链下工作机的概念总览，可参阅<a href="../learn-substrate/off-chain-features#off-chain-workers">《概念指南》</a>。</p>
<h2><a class="anchor" aria-hidden="true" id="在-runtime-中使用链下工作机"></a><a href="#在-runtime-中使用链下工作机" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>在 Runtime 中使用链下工作机</h2>
<p>我们可为链下工作机单独创建一个pallet，来放置其业务逻辑。 在本示例中，我们将此 pallet 称为：<code>my_offchain_worker</code>。 它属于 runtime 的一部分，所以源文件目录为：<code>runtime/src/my_offchain_worker.rs</code>。</p>
<p>首先，导入下列模块：</p>
<pre><code class="hljs css language-rust"><span class="token comment">// For better debugging (printout) support</span>
<span class="token keyword">use</span> <span class="token namespace">support<span class="token punctuation">::</span></span><span class="token punctuation">{</span> debug<span class="token punctuation">,</span> dispatch <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">system<span class="token punctuation">::</span></span>offchain<span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">sp_runtime<span class="token punctuation">::</span>transaction_validity<span class="token punctuation">::</span></span><span class="token punctuation">{</span>
  <span class="token class-name">TransactionValidity</span><span class="token punctuation">,</span> <span class="token class-name">TransactionLongevity</span><span class="token punctuation">,</span> <span class="token class-name">ValidTransaction</span><span class="token punctuation">,</span> <span class="token class-name">InvalidTransaction</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<p>然后，在 pallet 的配置 trait 中包括以下关联类型，用于从链下工作机发送签名和无签名交易。</p>
<pre><code class="hljs css language-rust"><span class="token keyword">pub</span> <span class="token keyword">trait</span> <span class="token class-name">Trait</span><span class="token punctuation">:</span> <span class="token namespace">timestamp<span class="token punctuation">::</span></span><span class="token class-name">Trait</span> <span class="token operator">+</span> <span class="token namespace">system<span class="token punctuation">::</span></span><span class="token class-name">Trait</span> <span class="token punctuation">{</span>
  <span class="token comment">/// The overarching event type.</span>
  <span class="token keyword">type</span> <span class="token class-name">Event</span><span class="token punctuation">:</span> <span class="token class-name">From</span><span class="token operator">&lt;</span><span class="token class-name">Event</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">>></span> <span class="token operator">+</span> <span class="token class-name">Into</span><span class="token operator">&lt;&lt;</span><span class="token keyword">Self</span> <span class="token keyword">as</span> <span class="token namespace">system<span class="token punctuation">::</span></span><span class="token class-name">Trait</span><span class="token operator">></span><span class="token punctuation">::</span><span class="token class-name">Event</span><span class="token operator">></span><span class="token punctuation">;</span>
  <span class="token keyword">type</span> <span class="token class-name">Call</span><span class="token punctuation">:</span> <span class="token class-name">From</span><span class="token operator">&lt;</span><span class="token class-name">Call</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">>></span><span class="token punctuation">;</span>

  <span class="token keyword">type</span> <span class="token class-name">SubmitSignedTransaction</span><span class="token punctuation">:</span> <span class="token namespace">offchain<span class="token punctuation">::</span></span><span class="token class-name">SubmitSignedTransaction</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span><span class="token keyword">Self</span> <span class="token keyword">as</span> <span class="token class-name">Trait</span><span class="token operator">></span><span class="token punctuation">::</span><span class="token class-name">Call</span><span class="token operator">></span><span class="token punctuation">;</span>
  <span class="token keyword">type</span> <span class="token class-name">SubmitUnsignedTransaction</span><span class="token punctuation">:</span> <span class="token namespace">offchain<span class="token punctuation">::</span></span><span class="token class-name">SubmitUnsignedTransaction</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span><span class="token keyword">Self</span> <span class="token keyword">as</span> <span class="token class-name">Trait</span><span class="token operator">></span><span class="token punctuation">::</span><span class="token class-name">Call</span><span class="token operator">></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>接着，在 <code>decl_module！</code> 宏模块中，定义 <code>offchain_worker</code> 函数。 此函数作为链下工作机的入口，会在每次区块导入后运行。</p>
<pre><code class="hljs css language-rust"><span class="token macro property">decl_module!</span> <span class="token punctuation">{</span>
  <span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Module</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">Trait</span><span class="token operator">></span> <span class="token keyword">for</span> <span class="token keyword">enum</span> <span class="token type-definition class-name">Call</span> <span class="token keyword">where</span> origin<span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">::</span><span class="token class-name">Origin</span> <span class="token punctuation">{</span>

    <span class="token comment">// --snip--</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">offchain_worker</span><span class="token punctuation">(</span>block<span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">::</span><span class="token class-name">BlockNumber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token namespace">debug<span class="token punctuation">::</span></span><span class="token macro property">info!</span><span class="token punctuation">(</span><span class="token string">"Hello World."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>由于安全原因，在默认情况下链下工作机是无法直接访问用户密钥(即使在开发环境中) 的，它只能访问应用子密钥。 我们需要在runtime文件的顶部定义 <code>KeyTypeId</code> ，以能对应用子密钥进行分组。定义代码如下所示：</p>
<pre><code class="hljs css language-rust"><span class="token comment">// The key type ID can be any 4-character string</span>
<span class="token keyword">pub</span> <span class="token keyword">const</span> <span class="token constant">KEY_TYPE</span><span class="token punctuation">:</span> <span class="token class-name">KeyTypeId</span> <span class="token operator">=</span> <span class="token class-name">KeyTypeId</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token string">b"abcd"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// --snip--</span>

<span class="token keyword">pub</span> <span class="token keyword">mod</span> <span class="token module-declaration namespace">crypto</span> <span class="token punctuation">{</span>
  <span class="token keyword">pub</span> <span class="token keyword">use</span> <span class="token keyword">super</span><span class="token punctuation">::</span><span class="token constant">KEY_TYPE</span><span class="token punctuation">;</span>
  <span class="token keyword">use</span> <span class="token namespace">sp_runtime<span class="token punctuation">::</span>app_crypto<span class="token punctuation">::</span></span><span class="token punctuation">{</span>app_crypto<span class="token punctuation">,</span> sr25519<span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token macro property">app_crypto!</span><span class="token punctuation">(</span>sr25519<span class="token punctuation">,</span> <span class="token constant">KEY_TYPE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>和任何其他 pallet 一样，runtime 必须要实现该 pallet 的配置 trait。 我们可进入位于 <code>runtime/src/lib.rs</code> 目录下的 runtime <code>lib.rs</code>文件，作如下配置：</p>
<pre><code class="hljs css language-rust"><span class="token comment">// Define the transaction signer using the key definition</span>
<span class="token keyword">type</span> <span class="token class-name">SubmitTransaction</span> <span class="token operator">=</span> <span class="token namespace">system<span class="token punctuation">::</span>offchain<span class="token punctuation">::</span></span><span class="token class-name">TransactionSubmitter</span><span class="token operator">&lt;</span>
  <span class="token namespace">offchain_pallet<span class="token punctuation">::</span>crypto<span class="token punctuation">::</span></span><span class="token class-name">Public</span><span class="token punctuation">,</span> <span class="token class-name">Runtime</span><span class="token punctuation">,</span> <span class="token class-name">UncheckedExtrinsic</span><span class="token operator">></span><span class="token punctuation">;</span>

<span class="token keyword">impl</span> <span class="token namespace">offchain_pallet<span class="token punctuation">::</span></span><span class="token class-name">Trait</span> <span class="token keyword">for</span> <span class="token class-name">Runtime</span> <span class="token punctuation">{</span>
  <span class="token keyword">type</span> <span class="token class-name">Event</span> <span class="token operator">=</span> <span class="token class-name">Event</span><span class="token punctuation">;</span>
  <span class="token keyword">type</span> <span class="token class-name">Call</span> <span class="token operator">=</span> <span class="token class-name">Call</span><span class="token punctuation">;</span>

  <span class="token comment">// To use signed transactions in your runtime</span>
  <span class="token keyword">type</span> <span class="token class-name">SubmitSignedTransaction</span> <span class="token operator">=</span> <span class="token class-name">SubmitTransaction</span><span class="token punctuation">;</span>

  <span class="token comment">// To use unsigned transactions in your runtime</span>
  <span class="token keyword">type</span> <span class="token class-name">SubmitUnsignedTransaction</span> <span class="token operator">=</span> <span class="token class-name">SubmitTransaction</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>随后为 runtime 实现 <code>system::offchain::CreateTransaction</code>这个 trait。 继续在 <code>lib.rs</code> 文件中写入：</p>
<pre><code class="hljs css language-rust"><span class="token keyword">use</span> <span class="token namespace">sp_runtime<span class="token punctuation">::</span></span>transaction_validity<span class="token punctuation">;</span>

<span class="token comment">// --snip--</span>

<span class="token keyword">impl</span> <span class="token namespace">system<span class="token punctuation">::</span>offchain<span class="token punctuation">::</span></span><span class="token class-name">CreateTransaction</span><span class="token operator">&lt;</span><span class="token class-name">Runtime</span><span class="token punctuation">,</span> <span class="token class-name">UncheckedExtrinsic</span><span class="token operator">></span> <span class="token keyword">for</span> <span class="token class-name">Runtime</span> <span class="token punctuation">{</span>
  <span class="token keyword">type</span> <span class="token class-name">Public</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token class-name">Signature</span> <span class="token keyword">as</span> <span class="token class-name">Verify</span><span class="token operator">></span><span class="token punctuation">::</span><span class="token class-name">Signer</span><span class="token punctuation">;</span>
  <span class="token keyword">type</span> <span class="token class-name">Signature</span> <span class="token operator">=</span> <span class="token class-name">Signature</span><span class="token punctuation">;</span>

  <span class="token keyword">fn</span> <span class="token function-definition function">create_transaction</span><span class="token operator">&lt;</span><span class="token class-name">TSigner</span><span class="token punctuation">:</span> <span class="token namespace">system<span class="token punctuation">::</span>offchain<span class="token punctuation">::</span></span><span class="token class-name">Signer</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Public</span><span class="token punctuation">,</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Signature</span><span class="token operator">>></span> <span class="token punctuation">(</span>
    call<span class="token punctuation">:</span> <span class="token class-name">Call</span><span class="token punctuation">,</span>
    public<span class="token punctuation">:</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Public</span><span class="token punctuation">,</span>
    account<span class="token punctuation">:</span> <span class="token class-name">AccountId</span><span class="token punctuation">,</span>
    index<span class="token punctuation">:</span> <span class="token class-name">Index</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token class-name">Call</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span><span class="token class-name">UncheckedExtrinsic</span> <span class="token keyword">as</span> <span class="token namespace">sp_runtime<span class="token punctuation">::</span>traits<span class="token punctuation">::</span></span><span class="token class-name">Extrinsic</span><span class="token operator">></span><span class="token punctuation">::</span><span class="token class-name">SignaturePayload</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> period <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> current_block <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">::</span><span class="token function">block_number</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">saturated_into</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token keyword">u64</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> tip <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> extra<span class="token punctuation">:</span> <span class="token class-name">SignedExtra</span> <span class="token operator">=</span> <span class="token punctuation">(</span>
      <span class="token namespace">system<span class="token punctuation">::</span></span><span class="token class-name">CheckVersion</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">Runtime</span><span class="token operator">></span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token namespace">system<span class="token punctuation">::</span></span><span class="token class-name">CheckGenesis</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">Runtime</span><span class="token operator">></span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token namespace">system<span class="token punctuation">::</span></span><span class="token class-name">CheckEra</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">Runtime</span><span class="token operator">></span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token namespace">generic<span class="token punctuation">::</span></span><span class="token class-name">Era</span><span class="token punctuation">::</span><span class="token function">mortal</span><span class="token punctuation">(</span>period<span class="token punctuation">,</span> current_block<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token namespace">system<span class="token punctuation">::</span></span><span class="token class-name">CheckNonce</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">Runtime</span><span class="token operator">></span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token namespace">system<span class="token punctuation">::</span></span><span class="token class-name">CheckWeight</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">Runtime</span><span class="token operator">></span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token namespace">transaction_payment<span class="token punctuation">::</span></span><span class="token class-name">ChargeTransactionPayment</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">Runtime</span><span class="token operator">></span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span>tip<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> raw_payload <span class="token operator">=</span> <span class="token class-name">SignedPayload</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>call<span class="token punctuation">,</span> extra<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> signature <span class="token operator">=</span> <span class="token class-name">TSigner</span><span class="token punctuation">::</span><span class="token function">sign</span><span class="token punctuation">(</span>public<span class="token punctuation">,</span> <span class="token operator">&amp;</span>raw_payload<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> address <span class="token operator">=</span> <span class="token class-name">Indices</span><span class="token punctuation">::</span><span class="token function">unlookup</span><span class="token punctuation">(</span>account<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span>call<span class="token punctuation">,</span> extra<span class="token punctuation">,</span> _<span class="token punctuation">)</span> <span class="token operator">=</span> raw_payload<span class="token punctuation">.</span><span class="token function">deconstruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token punctuation">(</span>call<span class="token punctuation">,</span> <span class="token punctuation">(</span>address<span class="token punctuation">,</span> signature<span class="token punctuation">,</span> extra<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>如果想在链下工作机中使用无签名交易，则需要在 <code>contrast_runtime!</code> 宏下的OffchainPallet中添加名为 <code>ValidateUnsigned</code>的额外参数，与所有其它pallet及其参数一起作为runtime的组成部分。 另外，还需要为此单独编写自定义的 <a href="../learn-substrate/extrinsics">验证逻辑</a>。</p>
<pre><code class="hljs css language-rust"><span class="token macro property">construct_runtime!</span><span class="token punctuation">(</span>
  <span class="token keyword">pub</span> <span class="token keyword">enum</span> <span class="token type-definition class-name">Runtime</span> <span class="token keyword">where</span>
    <span class="token class-name">Block</span> <span class="token operator">=</span> <span class="token class-name">Block</span><span class="token punctuation">,</span>
    <span class="token class-name">NodeBlock</span> <span class="token operator">=</span> <span class="token namespace">opaque<span class="token punctuation">::</span></span><span class="token class-name">Block</span><span class="token punctuation">,</span>
    <span class="token class-name">UncheckedExtrinsic</span> <span class="token operator">=</span> <span class="token class-name">UncheckedExtrinsic</span>
  <span class="token punctuation">{</span>
    <span class="token comment">// --snip--</span>

    <span class="token comment">// To use unsigned transactions</span>
    <span class="token class-name">OffchainPallet</span><span class="token punctuation">:</span> <span class="token namespace">offchain_pallet<span class="token punctuation">::</span></span><span class="token punctuation">{</span> <span class="token class-name">Module</span><span class="token punctuation">,</span> <span class="token class-name">Call</span><span class="token punctuation">,</span> <span class="token class-name">Storage</span><span class="token punctuation">,</span> <span class="token class-name">Event</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token namespace">transaction_validity<span class="token punctuation">::</span></span><span class="token class-name">ValidateUnsigned</span> <span class="token punctuation">}</span>

    <span class="token comment">// If you are only using signed transactions, it can just be:</span>
    <span class="token comment">// OffchainPallet: offchain_pallet::{ Module, Call, Storage, Event&lt;T> }</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="在-servicers-文件中添加密钥"></a><a href="#在-servicers-文件中添加密钥" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>在 <code>service.rs</code> 文件中添加密钥</h2>
<p>我们用<code>KeyTypeId</code>指定了一个本地密钥库来存储应用子密钥，链外工作机可以通过访问这些密钥来签发交易。 可通过以下两种方式添加应用子密钥。</p>
<h3><a class="anchor" aria-hidden="true" id="选项-1（开发阶段）：添加第一个用户密钥作为应用子密钥"></a><a href="#选项-1（开发阶段）：添加第一个用户密钥作为应用子密钥" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>选项 1（开发阶段）：添加第一个用户密钥作为应用子密钥</h3>
<p>在开发环境中，可将第一个用户的密钥添加为应用子密钥。 在 <code>node/src/service.rs</code> 文件中作如下代码更新：</p>
<pre><code class="hljs css language-rust"><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">new_full</span><span class="token operator">&lt;</span><span class="token class-name">C</span><span class="token punctuation">:</span> <span class="token class-name">Send</span> <span class="token operator">+</span> <span class="token class-name">Default</span> <span class="token operator">+</span> <span class="token lifetime-annotation symbol">'static</span><span class="token operator">></span><span class="token punctuation">(</span>config<span class="token punctuation">:</span> <span class="token class-name">Configuration</span><span class="token operator">&lt;</span><span class="token class-name">C</span><span class="token punctuation">,</span> <span class="token class-name">GenesisConfig</span><span class="token operator">></span><span class="token punctuation">)</span>
  <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token keyword">impl</span> <span class="token class-name">AbstractService</span><span class="token punctuation">,</span> <span class="token class-name">ServiceError</span><span class="token operator">></span>
<span class="token punctuation">{</span>
  <span class="token comment">// --snip--</span>

  <span class="token comment">// This clones the key for Alice.</span>
  <span class="token keyword">let</span> dev_seed <span class="token operator">=</span> config<span class="token punctuation">.</span>dev_key_seed<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// --snip--</span>

  <span class="token keyword">let</span> service <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">with_network_protocol</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>_<span class="token closure-punctuation punctuation">|</span></span> <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token class-name">NodeProtocol</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">?</span>
    <span class="token punctuation">.</span><span class="token function">with_finality_proof_provider</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>client<span class="token punctuation">,</span> backend<span class="token closure-punctuation punctuation">|</span></span>
      <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">GrandpaFinalityProofProvider</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>backend<span class="token punctuation">,</span> client<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> _<span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token operator">?</span>
    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

  <span class="token comment">// Add the following section to add the key to the keystore.</span>
  <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>seed<span class="token punctuation">)</span> <span class="token operator">=</span> dev_seed <span class="token punctuation">{</span>
    service
      <span class="token punctuation">.</span><span class="token function">keystore</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">insert_ephemeral_from_seed_by_type</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token namespace">runtime<span class="token punctuation">::</span>offchain_pallet<span class="token punctuation">::</span>crypto<span class="token punctuation">::</span></span><span class="token class-name">Pair</span><span class="token operator">></span><span class="token punctuation">(</span>
        <span class="token operator">&amp;</span>seed<span class="token punctuation">,</span>
        <span class="token namespace">runtime<span class="token punctuation">::</span>offchain_pallet<span class="token punctuation">::</span></span><span class="token constant">KEY_TYPE</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">"Dev Seed should always succeed."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>完成后即可进行签名交易了。 但此仅供 <strong>开发环境</strong> 中使用。</p>
<h3><a class="anchor" aria-hidden="true" id="选项2：通过-cli-添加应用子密钥"></a><a href="#选项2：通过-cli-添加应用子密钥" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>选项2：通过 CLI 添加应用子密钥</h3>
<p>在实际环境中，设置好 Substrate 节点后可通过命令行界面添加一个新的应用子密钥。操作如下所示：</p>
<pre><code class="hljs css language-bash"><span class="hljs-comment"># Generate a new account</span>
$ subkey generate

<span class="hljs-comment"># Submit a new key via RPC</span>
$ curl http://localhost:9933 -H <span class="hljs-string">"Content-Type:application/json;charset=utf-8"</span> -d \
  <span class="hljs-string">'{
    "jsonrpc":"2.0",
    "id":1,
    "method":"author_insertKey",
    "params": [
      "&lt;YourKeyTypeId&gt;",
      "&lt;YourSeedPhrase&gt;",
      "&lt;YourPublicKey&gt;"
    ]
  }'</span>
</code></pre>
<p>如果命令和参数输入正确，则节点将返回如下的JSON响应：</p>
<pre><code class="hljs css language-json">{ <span class="hljs-attr">"jsonrpc"</span>: <span class="hljs-string">"2.0"</span>, <span class="hljs-attr">"result"</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">"id"</span>: <span class="hljs-number">1</span> }
</code></pre>
<p>新密钥就成功添加到本地密钥库了。</p>
<h2><a class="anchor" aria-hidden="true" id="签名交易"></a><a href="#签名交易" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>签名交易</h2>
<p>现在我们已经做好用链下工作机签发签名交易的准备了。 回到<code>my_offchain_worker.rs</code>这个pallet中：</p>
<pre><code class="hljs css language-rust"><span class="token macro property">decl_module!</span> <span class="token punctuation">{</span>
  <span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Module</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">Trait</span><span class="token operator">></span> <span class="token keyword">for</span> <span class="token keyword">enum</span> <span class="token type-definition class-name">Call</span> <span class="token keyword">where</span> origin<span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">::</span><span class="token class-name">Origin</span> <span class="token punctuation">{</span>
    <span class="token comment">// --snip--</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">onchain_callback</span><span class="token punctuation">(</span>origin<span class="token punctuation">,</span> _block<span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">::</span><span class="token class-name">BlockNumber</span><span class="token punctuation">,</span> input<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">u8</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token namespace">dispatch<span class="token punctuation">::</span></span><span class="token class-name">Result</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> who <span class="token operator">=</span> <span class="token function">ensure_signed</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
      <span class="token namespace">debug<span class="token punctuation">::</span></span><span class="token macro property">info!</span><span class="token punctuation">(</span><span class="token string">"{:?}"</span><span class="token punctuation">,</span> <span class="token namespace">core<span class="token punctuation">::</span></span><span class="token keyword">str</span><span class="token punctuation">::</span><span class="token function">from_utf8</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>input<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">offchain_worker</span><span class="token punctuation">(</span>block<span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">::</span><span class="token class-name">BlockNumber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Here we specify the function to be called back on-chain in next block import.</span>
      <span class="token keyword">let</span> call <span class="token operator">=</span> <span class="token class-name">Call</span><span class="token punctuation">::</span><span class="token function">onchain_callback</span><span class="token punctuation">(</span>block<span class="token punctuation">,</span> <span class="token string">b"hello world!"</span><span class="token punctuation">.</span><span class="token function">to_vec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">T</span><span class="token punctuation">::</span><span class="token class-name">SubmitSignedTransaction</span><span class="token punctuation">::</span><span class="token function">submit_signed</span><span class="token punctuation">(</span>call<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>定义了链上回调函数后，在链外工作机中即可指定这个回调函数在下一个区块导入阶段中执行。 接下来我们就可以向节点提交签名交易了。</p>
<p>如果在<a href="https://github.com/paritytech/substrate/blob/a98625501be68cc3084e666497c16b111741dded/frame/system/src/offchain.rs#L106-L115">Substrate代码库</a>中查看<code>fn system::offchain::submit_signed</code> 的实现，我们能看到它为本地密钥库中的每个密钥都调用了链上回调函数。 但由于现在本地密钥库中只有一个密钥，因此只会调用该函数一次。</p>
<p><a href="../learn-substrate/extrinsics#signed-transactions">了解更多关于签名交易的信息</a>。</p>
<h2><a class="anchor" aria-hidden="true" id="无签名交易"></a><a href="#无签名交易" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>无签名交易</h2>
<p>可通过以下代码将无签名交易发送回链上。</p>
<pre><code class="hljs css language-rust"><span class="token macro property">decl_module!</span> <span class="token punctuation">{</span>
  <span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Module</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">Trait</span><span class="token operator">></span> <span class="token keyword">for</span> <span class="token keyword">enum</span> <span class="token type-definition class-name">Call</span> <span class="token keyword">where</span> origin<span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">::</span><span class="token class-name">Origin</span> <span class="token punctuation">{</span>
    <span class="token comment">// --snip--</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">onchain_callback</span><span class="token punctuation">(</span>_origin<span class="token punctuation">,</span> _block<span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">::</span><span class="token class-name">BlockNumber</span><span class="token punctuation">,</span> input<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">u8</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token namespace">dispatch<span class="token punctuation">::</span></span><span class="token class-name">Result</span> <span class="token punctuation">{</span>
      <span class="token namespace">debug<span class="token punctuation">::</span></span><span class="token macro property">info!</span><span class="token punctuation">(</span><span class="token string">"{:?}"</span><span class="token punctuation">,</span> <span class="token namespace">core<span class="token punctuation">::</span></span><span class="token keyword">str</span><span class="token punctuation">::</span><span class="token function">from_utf8</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>input<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">offchain_worker</span><span class="token punctuation">(</span>block<span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">::</span><span class="token class-name">BlockNumber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Here we specify the function to be called back on-chain in next block import.</span>
      <span class="token keyword">let</span> call <span class="token operator">=</span> <span class="token class-name">Call</span><span class="token punctuation">::</span><span class="token function">onchain_callback</span><span class="token punctuation">(</span>block<span class="token punctuation">,</span> <span class="token string">b"hello world!"</span><span class="token punctuation">.</span><span class="token function">to_vec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">T</span><span class="token punctuation">::</span><span class="token class-name">SubmitUnsignedTransaction</span><span class="token punctuation">::</span><span class="token function">submit_unsigned</span><span class="token punctuation">(</span>call<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>默认情况下，所有无签名交易都被视为无效交易。 需要在<code>my_offchain_worker.rs</code> 中添加以下代码段，以明确允许提交无签名交易。</p>
<pre><code class="hljs css language-rust"><span class="token macro property">decl_module!</span> <span class="token punctuation">{</span>
  <span class="token comment">// --snip--</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">Trait</span><span class="token operator">></span> <span class="token class-name">Module</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span> <span class="token punctuation">{</span>
  <span class="token comment">// --snip--</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[allow(deprecated)]</span>
<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">Trait</span><span class="token operator">></span> <span class="token namespace">support<span class="token punctuation">::</span>unsigned<span class="token punctuation">::</span></span><span class="token class-name">ValidateUnsigned</span> <span class="token keyword">for</span> <span class="token class-name">Module</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span> <span class="token punctuation">{</span>
  <span class="token keyword">type</span> <span class="token class-name">Call</span> <span class="token operator">=</span> <span class="token class-name">Call</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span><span class="token punctuation">;</span>

  <span class="token keyword">fn</span> <span class="token function-definition function">validate_unsigned</span><span class="token punctuation">(</span>call<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Call</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">TransactionValidity</span> <span class="token punctuation">{</span>

    <span class="token keyword">match</span> call <span class="token punctuation">{</span>
      <span class="token class-name">Call</span><span class="token punctuation">::</span><span class="token function">onchain_callback</span><span class="token punctuation">(</span>block<span class="token punctuation">,</span> input<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token class-name">ValidTransaction</span> <span class="token punctuation">{</span>
        priority<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        requires<span class="token punctuation">:</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        provides<span class="token punctuation">:</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token punctuation">(</span>block<span class="token punctuation">,</span> input<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        longevity<span class="token punctuation">:</span> <span class="token class-name">TransactionLongevity</span><span class="token punctuation">::</span><span class="token function">max_value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        propagate<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      _ <span class="token operator">=></span> <span class="token class-name">InvalidTransaction</span><span class="token punctuation">::</span><span class="token class-name">Call</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>当前由于此块API仍在过渡中，因此需要额外添加 <code>deprecated</code>属性，以禁用系统对无签名交易的警告提示。 我们会在后期发布的Substrate版本中对此进行更新。 现在请暂时谨慎使用。</p>
<p><a href="../learn-substrate/extrinsics#unsigned-transactions">了解更多关于无签名交易的信息</a>。</p>
<h2><a class="anchor" aria-hidden="true" id="链上回调函数中的参数"></a><a href="#链上回调函数中的参数" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>链上回调函数中的参数</h2>
<p>在进行链上回调时，回调函数名称及其所有参数值会被一起哈希。 回调函数将被存储下来，并在下一个区块导入期间被调用。 如果我们发现哈希值已经存在，这意味着之前已调用了具有相同参数集的函数，那么对于签名交易，我们将用采用更高优先级的回调； 而对于无签名交易，此回调函数将被忽略。</p>
<p>如果你的pallet经常进行链上回调，并且估计它偶尔有重复的参数集，则可从 <code>offchain_worker</code> 函数中传入当前区块号作为额外参数。 区块号只会一直增加，并能保证是唯一的。</p>
<h2><a class="anchor" aria-hidden="true" id="获取外部数据"></a><a href="#获取外部数据" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>获取外部数据</h2>
<p>要从第三方API获取外部数据，请使用<code>my_offchain_worker.rs</code>中的<code>offchain::http</code>库，代码如下所示：</p>
<pre><code class="hljs css language-rust"><span class="token keyword">use</span> <span class="token namespace">sp_runtime<span class="token punctuation">::</span></span><span class="token punctuation">{</span>
  <span class="token namespace">offchain<span class="token punctuation">::</span></span>http<span class="token punctuation">,</span>
  <span class="token namespace">transaction_validity<span class="token punctuation">::</span></span><span class="token punctuation">{</span>
    <span class="token class-name">TransactionValidity</span><span class="token punctuation">,</span> <span class="token class-name">TransactionLongevity</span><span class="token punctuation">,</span> <span class="token class-name">ValidTransaction</span><span class="token punctuation">,</span> <span class="token class-name">InvalidTransaction</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// --snip--</span>

<span class="token macro property">decl_module!</span> <span class="token punctuation">{</span>
  <span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Module</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">Trait</span><span class="token operator">></span> <span class="token keyword">for</span> <span class="token keyword">enum</span> <span class="token type-definition class-name">Call</span> <span class="token keyword">where</span> origin<span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">::</span><span class="token class-name">Origin</span> <span class="token punctuation">{</span>
    <span class="token comment">// --snip--</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">offchain_worker</span><span class="token punctuation">(</span>block<span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">::</span><span class="token class-name">BlockNumber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">match</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token function">fetch_data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token namespace">debug<span class="token punctuation">::</span></span><span class="token macro property">info!</span><span class="token punctuation">(</span><span class="token string">"Result: {}"</span><span class="token punctuation">,</span> <span class="token namespace">core<span class="token punctuation">::</span></span><span class="token keyword">str</span><span class="token punctuation">::</span><span class="token function">from_utf8</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">Err</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token namespace">debug<span class="token punctuation">::</span></span><span class="token macro property">error!</span><span class="token punctuation">(</span><span class="token string">"Error fetch_data: {}"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">Trait</span><span class="token operator">></span> <span class="token class-name">Module</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span> <span class="token punctuation">{</span>
  <span class="token keyword">fn</span> <span class="token function-definition function">fetch_data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">u8</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'static</span> <span class="token keyword">str</span><span class="token operator">></span> <span class="token punctuation">{</span>

    <span class="token comment">// Specifying the request</span>
    <span class="token keyword">let</span> pending <span class="token operator">=</span> <span class="token namespace">http<span class="token punctuation">::</span></span><span class="token class-name">Request</span><span class="token punctuation">::</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"https://min-api.cryptocompare.com/data/price?fsym=BTC&amp;tsyms=USD"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">map_err</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>_<span class="token closure-punctuation punctuation">|</span></span> <span class="token string">"Error in sending http GET request"</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

    <span class="token comment">// Waiting for the response</span>
    <span class="token keyword">let</span> response <span class="token operator">=</span> pending<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">map_err</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>_<span class="token closure-punctuation punctuation">|</span></span> <span class="token string">"Error in waiting http response back"</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

    <span class="token comment">// Check if the HTTP response is okay</span>
    <span class="token keyword">if</span> response<span class="token punctuation">.</span>code <span class="token operator">!=</span> <span class="token number">200</span> <span class="token punctuation">{</span>
      <span class="token namespace">debug<span class="token punctuation">::</span></span><span class="token macro property">warn!</span><span class="token punctuation">(</span><span class="token string">"Unexpected status code: {}"</span><span class="token punctuation">,</span> response<span class="token punctuation">.</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token string">"Non-200 status code returned from http request"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Collect the result in the form of bytes</span>
    <span class="token class-name">Ok</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">u8</span><span class="token operator">>></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>接收到结果之后，您可能需要将它解析为JSON格式。 我们提供了一个使用外部库在<code>no_std</code>环境中解析JSON结果的<a href="https://github.com/jimmychu0807/substrate-offchain-pricefetch/blob/047ad8094dc21e2bced2d055707756265be32e95/node/runtime/src/price_fetch.rs#L250-L260">示例</a>。</p>
<!--
[comment]: # (TODO: Signing Transactions with Session Keys)
[comment]: # (TODO: Local Key-Value Database)
[comment]: # (TODO: Writing Tests)
-->
<h2><a class="anchor" aria-hidden="true" id="下一步"></a><a href="#下一步" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>下一步</h2>
<h3><a class="anchor" aria-hidden="true" id="进一步学习"></a><a href="#进一步学习" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>进一步学习</h3>
<ul>
<li><a href="../learn-substrate/off-chain-features#off-chain-workers">Off-Chain Features Conceptual Guide</a></li>
<li><a href="../learn-substrate/extrinsics#signed-transactions">签名交易</a></li>
<li><a href="../learn-substrate/extrinsics#unsigned-transactions">无签名交易</a></li>
</ul>
<h3><a class="anchor" aria-hidden="true" id="例子"></a><a href="#例子" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>例子</h3>
<ul>
<li><a href="https://github.com/tomusdrw/sub0-offchain-workshop">Sub0 工作坊的链下工作机相关资料</a></li>
<li><a href="https://github.com/jimmychu0807/substrate-offchain-pricefetch">用链下工作机获取价格</a></li>
<li>(废弃) <a href="https://github.com/gnunicorn/substrate-offchain-cb">用Substrate v1 API进行链下工作机回调</a></li>
</ul>
<h3><a class="anchor" aria-hidden="true" id="参考文档"></a><a href="#参考文档" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>参考文档</h3>
<ul>
<li>Substrate的<a href="https://github.com/paritytech/substrate/blob/master/frame/im-online/src/lib.rs"><code>im-online</code> pallet</a>，使用链下工作机将网络验证人的在线状态通知给其他节点。</li>
</ul>
</span></div></article></div><div class="docs-prevnext"><a class="docs-prev button" href="/docs/zh-CN/knowledgebase/runtime/fees"><span class="arrow-prev">← </span><span>交易费用</span></a><a class="docs-next button" href="/docs/zh-CN/knowledgebase/runtime/debugging"><span>调试</span><span class="arrow-next"> →</span></a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#在-runtime-中使用链下工作机">在 Runtime 中使用链下工作机</a></li><li><a href="#在-servicers-文件中添加密钥">在 <code>service.rs</code> 文件中添加密钥</a><ul class="toc-headings"><li><a href="#选项-1（开发阶段）：添加第一个用户密钥作为应用子密钥">选项 1（开发阶段）：添加第一个用户密钥作为应用子密钥</a></li><li><a href="#选项2：通过-cli-添加应用子密钥">选项2：通过 CLI 添加应用子密钥</a></li></ul></li><li><a href="#签名交易">签名交易</a></li><li><a href="#无签名交易">无签名交易</a></li><li><a href="#链上回调函数中的参数">链上回调函数中的参数</a></li><li><a href="#获取外部数据">获取外部数据</a></li><li><a href="#下一步">下一步</a><ul class="toc-headings"><li><a href="#进一步学习">进一步学习</a></li><li><a href="#例子">例子</a></li><li><a href="#参考文档">参考文档</a></li></ul></li></ul></nav></div><footer class="nav-footer" id="footer"><section class="sitemap"><a href="/" class="nav-home"><img src="/img/Substrate-logo.svg" alt="Substrate Developer Hub" width="66" height="58"/></a><div><h5>开发者中心</h5><a href="/zh-CN/tutorials">教程</a><a href="/docs/zh-CN/">知识库</a><a href="https://substrate.dev/recipes/">进阶菜谱</a><a href="https://substrate.dev/rustdocs">API 文档</a></div><div><h5>社区</h5><a href="/zh-CN/community">社区主页</a><a href="/zh-CN/newsletter">通讯</a><a href="https://app.element.io/#/room/!HzySYSaIhtyWrwiwEV:matrix.org">Substrate 技术聊天室</a><a href="/zh-CN/seminar">Substrate 研讨会</a><a href="http://stackoverflow.com/questions/tagged/substrate" target="_blank" rel="noreferrer noopener">Stack Overflow</a><a href="https://twitter.com/ParityTech" target="_blank" rel="noreferrer noopener">推特</a><a href="https://www.meetup.com/parity/" target="_blank" rel="noreferrer noopener">聚会活动</a></div><div><h5>更多</h5><a href="https://www.substrate.io/builders-program/">Substrate Builders 计划</a><a href="https://www.parity.io/blog/">Blog</a><a href="https://github.com/paritytech/substrate">Substrate GitHub</a><a href="https://github.com/substrate-developer-hub/">开发者中心 GitHub</a><a href="https://www.parity.io/privacy/">隐私政策</a><a href="/terms">使用条款</a><a href="#" id="cookie-settings">Cookie 设置<script>
                var cookieSettings = document.getElementById('cookie-settings');
                cookieSettings.onclick = function() {
                  return klaro.show();
                };
              </script></a></div></section><section class="copyright">Copyright © 2021 Parity Technologies</section></footer></div><script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script><script>
                document.addEventListener('keyup', function(e) {
                  if (e.target !== document.body) {
                    return;
                  }
                  // keyCode for '/' (slash)
                  if (e.keyCode === 191) {
                    const search = document.getElementById('search_input_react');
                    search && search.focus();
                  }
                });
              </script><script>
              var search = docsearch({
                
                apiKey: '5cd09916f4ba4c283b2d45ee7386fc34',
                indexName: 'substrate',
                inputSelector: '#search_input_react',
                algoliaOptions: {"facetFilters":["language:zh-CN"]}
              });
            </script></body></html>